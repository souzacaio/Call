<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Security-Policy" content="default-src * 'self' 'unsafe-inline' 'unsafe-eval' data: gap: content:">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#2196f3">
  <meta name="format-detection" content="telephone=no">
  <meta name="msapplication-tap-highlight" content="no">
  <title>Control Call</title>
  <link rel="stylesheet" href="framework7/css/framework7.bundle.min.css">
  <link rel="stylesheet" href="css/icons.css">
  <link rel="stylesheet" href="css/app.css">
  <!---<script src="https://jssip.net/download/releases/jssip-0.7.22.min.js"></script>-->
  <script src="js/jssip7-23.js"></script>
  
  <!---
    
        Autor : Caio Souza. 
        E-mail: caio.souza@live.com
        Data  : 25/04/2019
  -->

  <script>
  
        window.onload = function(){
        document.addEventListener('deviceready',iniciar);
        }

        function iniciar(){
         
        }

      </script>

      <style>
      
        .online{

            width: 5px;
            height: 5px;
            background-color: #b0afaf;
            padding: 7px;
            border-radius: 100px;
            margin-left: 98px;
            margin-right: 8px;
            margin-top: 1px;

        }

        .online-t{

            font-size: 14px;
            color:#b0afaf;
            margin-top: 2px

        }

        .calling{

              background-image: url(https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRtFuwAp_SwqAdQb2O-wU5BBzwLI1QlyZqthSjfDoiX3avrp8TZ);
              height: auto;
              background-size: 100% 100%;
              bottom: 0;
              color: black;
              left: 0;
              overflow: auto;
              padding: 3em;
              position: absolute;
              z-index: 10000;
              right: 0;
              top: 0;
              background-repeat: no-repeat;
              display:none

        }

        .atender{

              position:relative;
              width:26%;
              float:left;
           
        }


        .finalizar{

              position:relative;
              width:50%;
              float:right;
           
        }

        .btncall{

              top: 67%;
              width: 100%;
              position: relative;

        }

        .groupbtn{

               position: relative;
               width: 100%;
               top: 31%;

        }

        .timer-timer{

           padding: 0 0px 0 223px;
            position: relative;
            width: 100%;
            top: 19%;
            right: 35%;
            color: white;

        }

      </style>

</head>
<body>
  <div id="app">
      <div class="calling">
					<div class="row" style="position: relative;top: 12%;"> 
								<span id="whocalling" style="color: white;font-size: 21px;top: 3px;position: relative; left: 17%;"></span>
					</div>
					<div class="row no-gap timer-timer"> 
						<div class="col-100 " onclick="audio_device(this)">
								<span class="timer_calling"></span>
						</div> 
				</div>
          <div class="groupbtn row no-gap"> 
              <div class="col-50 closed" onclick="audio_device(this)">
                  <i class="f7-icons " style="color:white;margin-left: 22px; font-size: 43px;">volume_mute_fill</i><br><span style="color: white;">Auto - Falante</span>
              </div>
              <div class="col-50" style="padding-left: 53px;">
                  <i class="f7-icons" style="color:white;margin-left: 22px; font-size: 43px;">mic_fill</i><br><span style="color: white;margin-left: 18px;">Mudo</span>
              </div> 
          </div>
          <div class="btncall"> 
              <span class="atd"><img src="img/aceitar.png" style="width:27%"/></span>
              <span class="finalizar"><img src="img/negar.png" style="width:55%;margin-left: 53px;"/></span>
          </div>
    </div>
    <!-- Status bar overlay for fullscreen mode-->
    <div class="statusbar"></div>
    <!-- Left panel with cover effect-->
    <div class="panel panel-left panel-cover theme-dark">
      <div class="view">
        <div class="page">
          <div class="navbar">
            <div class="navbar-inner">
              <div class="title">Left Panel</div>
            </div>
          </div>
          <div class="page-content">
            <div class="block">Left panel content goes here</div>
          </div>
        </div>
      </div>
    </div>
    <!-- Right panel with reveal effect-->
    <div class="panel panel-right panel-reveal theme-dark">
      <div class="view">
        <div class="page">
          <div class="navbar">
            <div class="navbar-inner">
              <div class="title">Right Panel</div>
            </div>
          </div>
          <div class="page-content">
            <div class="block">Right panel content goes here</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Views/Tabs container -->
    <div class="views tabs safe-areas">
      <!-- Tabbar for switching views-tabs -->
      <div class="toolbar tabbar-labels toolbar-bottom">
        <div class="toolbar-inner">
          <a href="#view-home" class="tab-link tab-link-active">
            <i class="icon f7-icons ios-only">home</i>
            <i class="icon f7-icons ios-only icon-ios-fill">home_fill</i>
            <i class="icon material-icons md-only">home</i>
            <span class="tabbar-label">Registrar</span>
          </a>
          <a href="#view-catalog" class="tab-link">
            <i class="icon f7-icons ios-only">list</i>
            <i class="icon f7-icons ios-only icon-ios-fill">list_fill</i>
            <i class="icon material-icons md-only">view_list</i>
            <span class="tabbar-label">Ligar</span>
          </a>
          <a href="#view-settings" class="tab-link">
            <i class="icon f7-icons ios-only">Sobre</i>
            <i class="icon f7-icons ios-only icon-ios-fill">settings_fill</i>
            <i class="icon material-icons md-only">settings</i>
            <span class="tabbar-label">Sobre</span>
          </a>
        </div>
      </div>
      <!-- Your main view/tab, should have "view-main" class. It also has "tab-active" class -->
      <div id="view-home" class="view view-main tab tab-active">
        <!-- Page, data-name contains page name which can be used in page callbacks -->
        <div class="page" data-name="home">
          <!-- Top Navbar -->
          <div class="navbar">
            <div class="navbar-inner">
              <div class="left">
                <!---<a href="#" class="link icon-only panel-open" data-panel="left">
                  <i class="icon f7-icons ios-only">menu</i>
                  <i class="icon material-icons md-only">menu</i>
                </a>-->
              </div>
              <div class="title sliding">Inicio</div>
              <div class="online"></div><span class="online-t">Desconectado</span>
              <div class="right">
                <a href="#" class="link icon-only panel-open" data-panel="right">
                  <i class="icon f7-icons ios-only">menu</i>
                  <i class="icon material-icons md-only">menu</i>
                </a>
              </div>
            </div>
          </div>

          <!-- Scrollable page content-->
          <div class="page-content">
                <div class="list no-hairlines-md" style="margin-top: 46px;">
                    <ul>
                        <li>
                            <div class="item-content item-input">
                              <div class="item-inner">
                                <div class="item-title item-label">Ramal</div>
                                <div class="item-input-wrap">
                                  <input type="number" placeholder="Ramal" id="ramal">
                                </div>
                              </div>
                            </div>
                          </li>
                          <li>
                            <div class="item-content item-input">
                              <div class="item-inner">
                                <div class="item-title item-label">Senha</div>
                                <div class="item-input-wrap">
                                  <input type="number" placeholder="Senha" id="ramalsenha">
                                </div>
                              </div>
                            </div>
                          </li>
                          <li>
                                <div class="item-content">
                                    <div class="item-inner">
                                    <div class="item-title">Manter Conectado</div>
                                    <div class="item-after">
                                        <label class="toggle toggle-init">
                                        <input type="checkbox">
                                        <span class="toggle-icon"></span>
                                        </label>
                                    </div>
                                    </div>
                                </div>
                            </li>
                        <div class="row"><button style="margin: 24px 0 0 24%;" class="col button button-raised button-fill color-blue btnregistrar" onclick="registrar()">Registrar</button><div></div>
                    </ul>
                </div>
          </div>
        </div>
      </div>

      <!-- Catalog View -->
      <div id="view-catalog" class="view tab">
        <!-- Catalog page will be loaded here dynamically from /catalog/ route -->
      </div>

      <!-- Settings View -->
      <div id="view-settings" class="view tab">
        <!-- Settings page will be loaded here dynamically from /settings/ route -->
      </div>
    </div>

    <!-- Popup -->
    <div class="popup" id="my-popup">
      <div class="view">
        <div class="page">
          <div class="navbar">
            <div class="navbar-inner">
              <div class="title">Popup</div>
              <div class="right">
                <a href="#" class="link popup-close">Close</a>
              </div>
            </div>
          </div>
          <div class="page-content">
            <div class="block">
              <p>Popup content goes here.</p>
            </div>
          </div>
        </div>
      </div>
    </div>

  <!-- Cordova -->
  
  <script src="cordova.js"></script>
  
  <!-- Framework7 library -->
  <script src="framework7/js/framework7.bundle.min.js"></script>

  <!-- App routes -->
  <script src="js/routes.js"></script>

  <!-- Your custom app scripts -->
  <script src="js/app.js"></script>
 
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  
<script>
        var ua          = '';
        var session     = '';
        var number      = '';
        var callOptions = '';
        var type_call   = '';
        var audio       = '';
        var tempo       = '';
        var identidade  = '';

        function smartphone () {

            var beepstop = false;
            this.play_bipe = function(){

              setInterval( function() {
                    if (!beepstop){navigator.notification.beep(3); navigator.notification.vibrate(800);}
              }, 5000);

            };

            this.stopBeep = function(){

                beepstop = true;

            }

            this.auto_falante = function(){

                AudioToggle.setAudioMode(AudioToggle.SPEAKER);

            }

            this.audio_normal = function(){

                AudioToggle.setAudioMode(AudioToggle.EARPIECE);

            } 
        }


        var celular = new smartphone();


        function registrar(){
           
            var ramal   = $('#ramal').val();
            var senha   = $('#ramalsenha').val();
            var retorno = false;
            ua = new JsSIP.UA({
                'uri': 'sip:000000000063'+ramal+'@leo.controlcondo.com.br', 
                'password': '000000000063'+senha, 
                'ws_servers': 'wss://leo.controlcondo.com.br:8089/ws',
            });

            /* Registra Ramal no Asterisk */
            ua.start();

            /* Faz ligação */
            $('.ligar').click(function(){
              
              var eventHandlers = {

                  'progress': function(e) {
                    $("#status-call").html('Chamando ...').show().css('color','#15b515');
                  },
                  'failed': function(e) { /* Chamada Finalizada. Lado de quem iniciou a ligacao */
                  
                    $("#status-call").html('Chamada finalizada ...').show().css('color','#ff443a');  
                    setTimeout(function(){
                        $("#status-call").hide();
                    },2500);

                  },
                  'ended': function(e) { /* Chamada Finalizada. Acao Lado de quem recebeu a ligacao */
                     $("#status-call").hide();
                  },
                  'confirmed': function(e) {
                    $("#status-call").html('Chamada em andamento ...').show().css('color','#15b515');
                  },

                };

                callOptions = {
                  'eventHandlers'    : eventHandlers,
                  'mediaConstraints' : { 'audio': true, 'video': false }
                };


                number = '000000000063'+document.getElementById('callramal').value;
                session  = ua.call('sip:'+number, callOptions);  

                session.on('addstream', function(e){

                      audio = document.createElement('audio');
                      audio.srcObject = e.stream;
                      audio.play();  
                      celular.audio_normal();

                })

            });

        
            ua.on("registered", function(data){
                
                $('.online').css('background-color','#21f329');
                $('.online-t').css('color','#21f329').html('Conectado <strong>'+ramal+'</strong>');
                $('.form1').hide();
                $('.form2').show();

            });

            ua.on("unregistered", function(data){
              console.log(data);
              
            });

            ua.on("disconnected", function(data){
              console.log(data);
             
            });

            ua.on("registrationFailed", function(data){
              console.log(data);
             
            });

            /* Encerra ligação (Lado de quem ligou)*/
           $('.encerrar').click(function(){
            
              ua.terminateSessions();
              $("#status-call").hide();
              //$("#status-call").hide();
            
              // ua.stop();
              //ua.start();
              
                /* 
                  list of methods that we can use in some cases (I just got it here because the site is get out yet)
                  session.isEnded()
                  ua.unregister();
                  ua.stop();
                  ua.terminate();
                  ua.sessiontTerminate();
                  session.isInProgress()

                */
           });

    
            /* check if there are some return of server side or client side */
            ua.on("newRTCSession", function(data){
      
              session        = data.session; 
              type_call      = session.direction;
              identidade     = session.remote_identity;
              var dtmfSender;


              /*
                list of methods that we can use in some cases (I just got it here because the site is get out yet)
                session.isEnded();
                session.isEstablished();
                session.isInProgress();
            */

              
            /* Encerra ligação (Lado de quem recebeu a ligacao)*/
            $('.finalizar').click(function(){
                        
                session.terminate();
                celular.stopBeep();
                $('.calling').hide();
                tempo.stop();

            });


            /* Atende ligação */
            $('.atd').click(function(){

                  celular.stopBeep();
                  session.answer();
                  tempo.start();

                  session.on('addstream', function(e){

                      audio = document.createElement('audio');
                      audio.srcObject = e.stream;
                      audio.play();  
                      celular.audio_normal();

                  })
              })

      
              /* Identifica Chamada Recebida */
              if(type_call == 'incoming'){
        
                  //celular.play_bipe();
                  $('.calling').show();
                   $('#whocalling').text(identidade.uri.user).show();

                  var intervalo = setInterval(function(){

                    if(session.isEnded()){
                      
                        $("#status-call").hide();
                        $('.calling').hide();
                        celular.stopBeep();
                        parar();
                        tempo.stop();
                
                    }

                  },1000);


                  function parar(){

                    clearInterval(intervalo);

                  }
               }
              
           });

      }

           
      /* Habilita Viva Voz (Ativo, Não Ativo)*/
      function audio_device(el){

            var status = $(el).attr('class');
            if(status.indexOf('closed') > 0){

              $(el).removeClass('closed').addClass('opened');
              $(el).html('<i class="f7-icons" style="color:white;margin-left: 22px; font-size: 43px;">volume_fill</i><br><span style="color: white;">Auto - Falante</span>');
              celular.auto_falante();
            }else
            if(status.indexOf('opened') > 0){


              $(el).removeClass('opened').addClass('closed');
              $(el).html('<i class="f7-icons" style="color:white;margin-left: 22px; font-size: 43px;">volume_mute_fill</i><br><span style="color: white;">Auto - Falante</span>');
              celular.audio_normal();
            }
       }

       
      function timer() {

        var segundos     = 0;
        var minutos      = 0;
        var valor        = '';
        var segundos_fmt = '';
        var minutos_fmt  = '';
        var repeticao    = '';
    
        /* Begin Timer */
        this.start = function(){
        
          repeticao = setInterval(function(){    

             if(segundos < 10){

                segundos_fmt = '0';
    
            }else 
            if(segundos >= 10 && segundos <= 60){
    
                segundos_fmt = '';
    
            }
    
            if(minutos < 10){
    
                minutos_fmt = '0';
    
            }else 
            if(minutos >= 10 && minutos <= 60){
    
                minutos_fmt = '';
    
            }
    
            valor = minutos_fmt+minutos+':'+segundos_fmt+segundos;	
    
            if(segundos == 60){
  
                minutos += 1;
                segundos = 0;

            }
    
            $('.timer_calling').text(valor).show();
            segundos = segundos+1;

            check = false;

          },1000);
          
        }

         /* Stop Timer */
        this.stop = function(){

          clearInterval(repeticao);
          $('.timer_calling').hide();
          segundos     = 0;
          minutos      = 0;

        }

     }

     tempo = new timer();

     function formata_ramal(ramal_txt){

      var inicio = '';
      var fim    = '';
      var ramal  = '';

      try{
         inicio = ramal_txt.indexOf('<')+5;
         fim    = ramal_txt.indexOf('@')-inicio;
         ramal  = ramal_txt.substr(inicio,fim);


      }catch{

        remal = 'erro';
      }
        

        return ramal;

     }


</script>
  
</body>
</html>
